name: Auto-merge PRs

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Auto-merge PR if checks pass
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Get the PR number
          let prNumber;
          
          if (context.eventName === 'pull_request_target') {
            prNumber = context.payload.pull_request.number;
          } else if (context.eventName === 'workflow_run') {
            const prs = context.payload.workflow_run.pull_requests;
            if (!prs || prs.length === 0) {
              console.log('No pull request associated with this workflow run');
              return;
            }
            prNumber = prs[0].number;
          } else {
            console.log('Unexpected event type');
            return;
          }
          
          console.log(`Processing PR #${prNumber}`);
          
          // Get the PR details
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          // Check if PR is mergeable
          if (pr.mergeable === false) {
            console.log('PR has merge conflicts');
            return;
          }
          
          if (pr.merged) {
            console.log('PR already merged');
            return;
          }
          
          // Get the combined status of all checks
          const { data: status } = await github.rest.repos.getCombinedStatusForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pr.head.sha
          });
          
          // Get check runs
          const { data: checkRuns } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pr.head.sha
          });
          
          // Check if all status checks passed
          const statusChecksPassed = status.state === 'success' || status.statuses.length === 0;
          
          // Check if all check runs passed
          const allCheckRunsCompleted = checkRuns.check_runs.length === 0 || 
            checkRuns.check_runs.every(check => check.status === 'completed');
          
          const allCheckRunsPassed = checkRuns.check_runs.length === 0 ||
            checkRuns.check_runs.every(check => 
              check.conclusion === 'success' || 
              check.conclusion === 'neutral' || 
              check.conclusion === 'skipped'
            );
          
          console.log(`Status checks: ${status.state} (passed: ${statusChecksPassed})`);
          console.log(`Check runs completed: ${allCheckRunsCompleted}`);
          console.log(`Check runs passed: ${allCheckRunsPassed}`);
          
          // Merge if all checks pass
          if (statusChecksPassed && allCheckRunsCompleted && allCheckRunsPassed) {
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'merge',
                commit_title: `Auto-merge PR #${prNumber}`,
                commit_message: 'Automatically merged because all checks passed'
              });
              console.log(`✓ Successfully merged PR #${prNumber}`);
            } catch (error) {
              console.log(`✗ Failed to merge PR #${prNumber}: ${error.message}`);
            }
          } else {
            console.log('Not all checks passed yet, skipping auto-merge');
          }
