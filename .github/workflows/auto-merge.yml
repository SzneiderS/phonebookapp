name: Auto-merge PRs

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Auto-merge PR if checks pass
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Only proceed if the workflow run was successful
          if (context.payload.workflow_run.conclusion !== 'success') {
            console.log('Workflow did not succeed, skipping auto-merge');
            return;
          }
          
          // Get the PR number
          const prs = context.payload.workflow_run.pull_requests;
          if (!prs || prs.length === 0) {
            console.log('No pull request associated with this workflow run');
            return;
          }
          
          if (prs.length > 1) {
            console.log(`Warning: Multiple PRs (${prs.length}) associated with this workflow run, processing only the first one`);
          }
          
          const prNumber = prs[0].number;
          
          console.log(`Processing PR #${prNumber}`);
          
          // Get the PR details
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          // Check if PR is in draft state
          if (pr.draft) {
            console.log('PR is in draft state, skipping auto-merge');
            return;
          }
          
          // Check if PR author has write permissions
          const { data: permissions } = await github.rest.repos.getCollaboratorPermissionLevel({
            owner: context.repo.owner,
            repo: context.repo.repo,
            username: pr.user.login
          });
          if (!['admin', 'write'].includes(permissions.permission)) {
            console.log('PR author does not have write permissions, skipping auto-merge');
            return;
          }
          
          // Check if PR is mergeable
          if (pr.mergeable !== true) {
            console.log('PR is not mergeable or mergeable state is unknown');
            return;
          }
          
          if (pr.merged) {
            console.log('PR already merged');
            return;
          }
          
          // Get the combined status of all checks
          const { data: status } = await github.rest.repos.getCombinedStatusForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pr.head.sha
          });
          
          // Get check runs
          const { data: checkRuns } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pr.head.sha
          });
          
          // Require that checks have actually run
          if (checkRuns.check_runs.length === 0 && status.statuses.length === 0) {
            console.log('No checks have run yet, skipping auto-merge');
            return;
          }
          
          // Check if all status checks passed (if any exist)
          const statusChecksPassed = status.statuses.length === 0 || status.state === 'success';
          
          // Check if all check runs passed (if any exist)
          const allCheckRunsCompleted = checkRuns.check_runs.length === 0 || 
            checkRuns.check_runs.every(check => check.status === 'completed');
          
          const allCheckRunsPassed = checkRuns.check_runs.length === 0 ||
            checkRuns.check_runs.every(check => 
              check.conclusion === 'success'
            );
          
          console.log(`Status checks: ${status.state} (passed: ${statusChecksPassed})`);
          console.log(`Check runs completed: ${allCheckRunsCompleted}`);
          console.log(`Check runs passed: ${allCheckRunsPassed}`);
          
          // Merge if all checks pass
          if (statusChecksPassed && allCheckRunsCompleted && allCheckRunsPassed) {
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'merge',
                commit_title: `Auto-merge PR #${prNumber}`,
                commit_message: 'Automatically merged because all checks passed'
              });
              console.log(`âœ“ Successfully merged PR #${prNumber}`);
            } catch (error) {
              core.setFailed(`Failed to merge PR #${prNumber}: ${error.message}`);
              throw error;
            }
          } else {
            console.log('Not all checks passed yet, skipping auto-merge');
          }
